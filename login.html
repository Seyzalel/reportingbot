<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Login — Reporting Bot</title>
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
<style>
:root{
  --bg: #09090b;
  --card-bg: #121214;
  --accent: #8b5cf6;
  --text: #e4e4e7;
  --muted: #71717a;
  --border: #27272a;
  --danger: #ef4444;
  --success: #10b981;
  --radius: 12px;
}
*{box-sizing:border-box}
body{
  margin:0;font-family:'Inter',sans-serif;
  background-color: var(--bg);
  background-image: radial-gradient(circle at 50% -20%, rgba(139, 92, 246, 0.15), transparent 50%);
  color:var(--text);
  min-height:100vh;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:20px;
}
.container{
  width:100%;
  max-width:400px;
}
.logo-area{
  text-align:center;
  margin-bottom:24px;
}
.logo-icon{
  width:48px;height:48px;
  background:linear-gradient(135deg, var(--accent), #6366f1);
  color:#fff;
  border-radius:12px;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  font-size:20px;
  box-shadow:0 10px 25px -10px rgba(139, 92, 246, 0.5);
  margin-bottom:12px;
}
.title{font-size:1.5rem;font-weight:700;margin:0}
.subtitle{color:var(--muted);margin-top:4px;font-size:0.9rem}

.card{
  background:var(--card-bg);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:32px;
  box-shadow:0 25px 50px -12px rgba(0,0,0,0.5);
}

.form-group{margin-bottom:16px;position:relative}
.label{display:block;font-size:0.85rem;font-weight:600;color:var(--text);margin-bottom:6px}
.input-wrap{position:relative}

.input{
  width:100%;
  background:#18181b;
  border:1px solid var(--border);
  color:#fff;
  padding:12px 16px;
  border-radius:8px;
  font-size:0.95rem;
  outline:none;
  transition:all 0.2s;
}
.input:focus{
  border-color:var(--accent);
  box-shadow:0 0 0 2px rgba(139, 92, 246, 0.15);
}
.input::placeholder{color:#3f3f46}

.icon-right{
  position:absolute; right:12px; top:50%; transform:translateY(-50%);
  color:var(--muted); cursor:pointer; font-size:0.9rem;
}

.error{
  color:var(--danger); font-size:0.8rem; margin-top:4px; min-height:16px; font-weight:500;
}

/* Flex row for Checkbox and Forgot Password */
.actions-row{
  display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; font-size:0.85rem;
}
.forgot-link{ color:var(--muted); text-decoration:none; transition:0.2s; }
.forgot-link:hover{ color:var(--text); }

/* Custom Checkbox */
.check-wrap{ display:flex; align-items:center; cursor:pointer; gap:8px; user-select:none; color:var(--muted); }
.check-input{ display:none; }
.check-box{
  width:18px; height:18px; border:1px solid var(--border); border-radius:4px; background:#18181b;
  display:flex; align-items:center; justify-content:center; transition:0.2s;
}
.check-input:checked + .check-box{ background:var(--accent); border-color:var(--accent); }
.check-box i{ color:white; font-size:10px; opacity:0; transform:scale(0.5); transition:0.2s; }
.check-input:checked + .check-box i{ opacity:1; transform:scale(1); }

.btn{
  width:100%;
  padding:12px;
  background:var(--accent);
  color:white;
  border:none;
  border-radius:8px;
  font-weight:600;
  cursor:pointer;
  transition:0.2s;
}
.btn:hover{background:#7c3aed}
.btn:disabled{opacity:0.6;cursor:not-allowed}

.footer-link{
  text-align:center; margin-top:20px; font-size:0.85rem; color:var(--muted);
}
.footer-link a{color:var(--accent);text-decoration:none;font-weight:600}

/* Toast Notification */
.toast{
  position:fixed; top:20px; left:50%; transform:translateX(-50%) translateY(-20px);
  background:#18181b; border:1px solid var(--border); padding:10px 16px;
  border-radius:50px; display:flex; align-items:center; gap:8px;
  opacity:0; transition:0.3s; font-size:0.9rem; pointer-events:none; z-index:99;
  box-shadow:0 10px 15px -3px rgba(0,0,0,0.3);
}
.toast.show{transform:translateX(-50%) translateY(0); opacity:1}
</style>
</head>
<body>

<div class="container">
  <div class="logo-area">
    <div class="logo-icon"><i class="fa-solid fa-robot"></i></div>
    <h1 class="title">Bem-vindo</h1>
    <div class="subtitle">Faça login para continuar</div>
  </div>

  <div class="card">
    <form id="loginForm" novalidate>
      
      <div class="form-group">
        <label class="label" for="username">Usuário</label>
        <div class="input-wrap">
          <input id="username" name="username" class="input" type="text" autocomplete="username" placeholder="Seu nome de usuário" required>
        </div>
        <div id="errU" class="error"></div>
      </div>

      <div class="form-group">
        <label class="label" for="password">Senha</label>
        <div class="input-wrap">
          <input id="password" name="password" class="input" type="password" autocomplete="current-password" placeholder="Sua senha" required>
          <i id="togglePw" class="fa-regular fa-eye icon-right" tabindex="0"></i>
        </div>
        <div id="errP" class="error"></div>
      </div>

      <div class="actions-row">
        <label class="check-wrap">
          <input type="checkbox" id="remember" class="check-input">
          <div class="check-box"><i class="fa-solid fa-check"></i></div>
          <span>Lembrar de mim</span>
        </label>
        <a href="/forgot" class="forgot-link">Esqueceu a senha?</a>
      </div>

      <button id="submitBtn" class="btn" type="submit">Entrar</button>

      <div class="footer-link">
        Não tem uma conta? <a href="/register">Cadastre-se</a>
      </div>
    </form>
  </div>
</div>

<div id="toast" class="toast">
  <i id="toastIcon"></i> <span id="toastText"></span>
</div>

<script>
// Elementos
const form = document.getElementById('loginForm');
const username = document.getElementById('username');
const password = document.getElementById('password');
const submitBtn = document.getElementById('submitBtn');
const togglePw = document.getElementById('togglePw');
const errU = document.getElementById('errU');
const errP = document.getElementById('errP');
const toast = document.getElementById('toast');
const toastText = document.getElementById('toastText');
const toastIcon = document.getElementById('toastIcon');

// Função de Toast
function showToast(msg, type){
  toastText.textContent = msg;
  toastIcon.className = type === 'error' ? 'fa-solid fa-circle-xmark' : 'fa-solid fa-circle-check';
  toastIcon.style.color = type === 'error' ? 'var(--danger)' : 'var(--success)';
  toast.classList.add('show');
  if(showToast._t) clearTimeout(showToast._t);
  showToast._t = setTimeout(() => toast.classList.remove('show'), 2000);
}

// Validação Básica
const isValidUsername = v => /^[a-zA-Z0-9._]{3,32}$/.test(v);

function validate(){
  let ok = true;
  errU.textContent = '';
  errP.textContent = '';
  
  const u = username.value.trim();
  const p = password.value;

  if(!isValidUsername(u)){
    errU.textContent = u.length === 0 ? 'Campo obrigatório' : 'Usuário inválido';
    ok = false;
  }
  
  if(p.length < 8){
    errP.textContent = p.length === 0 ? 'Campo obrigatório' : 'Mínimo de 8 caracteres';
    ok = false;
  }
  
  return ok;
}

// Listeners
username.addEventListener('input', () => { errU.textContent = ''; });
password.addEventListener('input', () => { errP.textContent = ''; });

togglePw.addEventListener('click', () => {
  const type = password.type === 'password' ? 'text' : 'password';
  password.type = type;
  togglePw.className = type === 'password' ? 'fa-regular fa-eye icon-right' : 'fa-regular fa-eye-slash icon-right';
});

// Envio do Formulário
form.addEventListener('submit', async function(e){
  e.preventDefault();
  
  if(!validate()) {
    showToast('Verifique os campos', 'error');
    return;
  }

  // Estado de Carregamento
  submitBtn.disabled = true;
  const originalBtnText = submitBtn.textContent;
  submitBtn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Entrando...';

  try{
    const payload = {
      username: username.value.trim(),
      password: password.value,
      remember: document.getElementById('remember').checked
    };

    const res = await fetch('/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
      credentials: 'same-origin',
      body: JSON.stringify(payload)
    });

    const data = await res.json().catch(()=>({}));

    if(res.ok && data && data.ok){
      showToast('Login efetuado com sucesso!', 'success');
      setTimeout(()=>{ window.location.href = data.redirect || '/dashboard'; }, 1000);
      return;
    }

    // Tratamento de Erros
    if(res.status === 400){
      showToast((data && data.error) || 'Dados inválidos', 'error');
    } else if(res.status === 401){
      errP.textContent = 'Usuário ou senha incorretos';
      showToast('Credenciais inválidas', 'error');
    } else {
      showToast((data && data.error) || 'Erro no servidor', 'error');
    }

  } catch(err){
    showToast('Falha de conexão. Tente novamente.', 'error');
  } finally {
    submitBtn.disabled = false;
    submitBtn.textContent = originalBtnText;
  }
});
</script>
</body>
</html>
