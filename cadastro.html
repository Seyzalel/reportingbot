<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Cadastro — Reporting Bot</title>
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
<style>
:root{
  --bg: #09090b;
  --card-bg: #121214;
  --accent: #8b5cf6;
  --text: #e4e4e7;
  --muted: #71717a;
  --border: #27272a;
  --danger: #ef4444;
  --success: #10b981;
  --radius: 12px;
}
*{box-sizing:border-box}
body{
  margin:0;font-family:'Inter',sans-serif;
  background-color: var(--bg);
  background-image: radial-gradient(circle at 50% -20%, rgba(139, 92, 246, 0.15), transparent 50%);
  color:var(--text);
  min-height:100vh;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:20px;
}
.container{
  width:100%;
  max-width:400px;
}
.logo-area{
  text-align:center;
  margin-bottom:24px;
}
.logo-icon{
  width:48px;height:48px;
  background:linear-gradient(135deg, var(--accent), #6366f1);
  color:#fff;
  border-radius:12px;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  font-size:20px;
  box-shadow:0 10px 25px -10px rgba(139, 92, 246, 0.5);
  margin-bottom:12px;
}
.title{font-size:1.5rem;font-weight:700;margin:0}
.subtitle{color:var(--muted);margin-top:4px;font-size:0.9rem}

.card{
  background:var(--card-bg);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:32px;
  box-shadow:0 25px 50px -12px rgba(0,0,0,0.5);
}

.form-group{margin-bottom:16px;position:relative}
.label{display:block;font-size:0.85rem;font-weight:600;color:var(--text);margin-bottom:6px}
.input-wrap{position:relative}

.input{
  width:100%;
  background:#18181b;
  border:1px solid var(--border);
  color:#fff;
  padding:12px 16px;
  border-radius:8px;
  font-size:0.95rem;
  outline:none;
  transition:all 0.2s;
}
.input:focus{
  border-color:var(--accent);
  box-shadow:0 0 0 2px rgba(139, 92, 246, 0.15);
}
.input::placeholder{color:#3f3f46}

.icon-right{
  position:absolute; right:12px; top:50%; transform:translateY(-50%);
  color:var(--muted); cursor:pointer; font-size:0.9rem;
}
.error{
  color:var(--danger); font-size:0.8rem; margin-top:4px; min-height:16px; font-weight:500;
}

.btn{
  width:100%;
  padding:12px;
  background:var(--accent);
  color:white;
  border:none;
  border-radius:8px;
  font-weight:600;
  cursor:pointer;
  transition:0.2s;
  margin-top:8px;
}
.btn:hover{background:#7c3aed}
.btn:disabled{opacity:0.6;cursor:not-allowed}

.footer-link{
  text-align:center; margin-top:20px; font-size:0.85rem; color:var(--muted);
}
.footer-link a{color:var(--accent);text-decoration:none;font-weight:600}

/* Password Strength Minimalist */
.meter{height:4px;background:#27272a;border-radius:2px;margin-top:8px;overflow:hidden;display:none} 
.meter.active{display:block}
.meter span{display:block;height:100%;transition:width 0.3s}

/* Toast Notification */
.toast{
  position:fixed; top:20px; left:50%; transform:translateX(-50%) translateY(-20px);
  background:#18181b; border:1px solid var(--border); padding:10px 16px;
  border-radius:50px; display:flex; align-items:center; gap:8px;
  opacity:0; transition:0.3s; font-size:0.9rem; pointer-events:none; z-index:99;
  box-shadow:0 10px 15px -3px rgba(0,0,0,0.3);
}
.toast.show{transform:translateX(-50%) translateY(0); opacity:1}
</style>
</head>
<body>

<div class="container">
  <div class="logo-area">
    <div class="logo-icon"><i class="fa-solid fa-robot"></i></div>
    <h1 class="title">Criar conta</h1>
    <div class="subtitle">Bem-vindo ao Reporting Bot</div>
  </div>

  <div class="card">
    <form id="signup" novalidate>
      
      <div class="form-group">
        <label class="label" for="username">Usuário</label>
        <div class="input-wrap">
          <input id="username" name="username" class="input" type="text" placeholder="Como devemos te chamar?" required>
          <i class="fa-solid fa-check icon-right" id="okU" style="color:var(--success);opacity:0"></i>
        </div>
        <div id="errU" class="error"></div>
      </div>

      <div class="form-group">
        <label class="label" for="email">E-mail</label>
        <div class="input-wrap">
          <input id="email" name="email" class="input" type="email" placeholder="seu@email.com" required>
          <i class="fa-solid fa-check icon-right" id="okE" style="color:var(--success);opacity:0"></i>
        </div>
        <div id="errE" class="error"></div>
      </div>

      <div class="form-group">
        <label class="label" for="password">Senha</label>
        <div class="input-wrap">
          <input id="password" name="password" class="input" type="password" placeholder="Mínimo 8 caracteres" required>
          <i id="togglePw" class="fa-regular fa-eye icon-right" tabindex="0"></i>
        </div>
        <div class="meter" id="meterWrap"><span id="meter"></span></div>
        <div id="errP" class="error"></div>
      </div>

      <div class="form-group">
        <label class="label" for="confirm">Confirmar senha</label>
        <div class="input-wrap">
          <input id="confirm" name="confirm" class="input" type="password" placeholder="Repita a senha" required>
        </div>
        <div id="errC" class="error"></div>
      </div>

      <button id="submit" class="btn" type="submit">Cadastrar</button>

      <div class="footer-link">
        Já possui conta? <a href="/login">Entrar</a>
      </div>
    </form>
  </div>
</div>

<div id="toast" class="toast">
  <i id="toastIcon"></i> <span id="toastText"></span>
</div>

<script>
// Referências aos elementos do DOM
const form = document.getElementById('signup');
const username = document.getElementById('username');
const email = document.getElementById('email');
const password = document.getElementById('password');
const confirm = document.getElementById('confirm');
const meterSpan = document.getElementById('meter');
const meterWrap = document.getElementById('meterWrap');
const togglePw = document.getElementById('togglePw');
const submitBtn = document.getElementById('submit');

// Elementos de Feedback (Erros e Ícones)
const errU = document.getElementById('errU');
const errE = document.getElementById('errE');
const errP = document.getElementById('errP');
const errC = document.getElementById('errC');
const okU = document.getElementById('okU');
const okE = document.getElementById('okE');

// Toast Notification
const toast = document.getElementById('toast');
const toastText = document.getElementById('toastText');
const toastIcon = document.getElementById('toastIcon');

function showToast(msg, type){
  toastText.textContent = msg;
  toastIcon.className = type === 'error' ? 'fa-solid fa-circle-xmark' : 'fa-solid fa-circle-check';
  toastIcon.style.color = type === 'error' ? 'var(--danger)' : 'var(--success)';
  toast.classList.add('show');
  if(showToast._t) clearTimeout(showToast._t);
  showToast._t = setTimeout(() => toast.classList.remove('show'), 2500);
}

// Helpers de Validação
const isValidUsername = v => /^[a-zA-Z0-9._]{3,32}$/.test(v);
const isValidEmail = v => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v);

// Função da Barra de Força da Senha
function checkPwStrength(v){
  if(v.length === 0) { meterWrap.classList.remove('active'); return; }
  meterWrap.classList.add('active');
  let s = 0;
  if(v.length >= 8) s++;
  if(/[A-Z]/.test(v)) s++;
  if(/[0-9]/.test(v)) s++;
  if(/[^A-Za-z0-9]/.test(v)) s++;
  const colors = ['#ef4444', '#ef4444', '#f59e0b', '#10b981', '#10b981'];
  const widths = ['20%', '40%', '60%', '80%', '100%'];
  meterSpan.style.width = widths[Math.min(s, 4)];
  meterSpan.style.background = colors[Math.min(s, 4)];
}

// Função Genérica de Validação de Campo
function validateField(input, validator, errEl, okIcon, errMsg){
  const valid = validator(input.value.trim());
  if(okIcon) okIcon.style.opacity = valid ? '1' : '0';
  errEl.textContent = valid || input.value.length === 0 ? '' : errMsg;
  return valid;
}

// Event Listeners (Digitação)
username.addEventListener('input', () => validateField(username, isValidUsername, errU, okU, 'Mínimo 3 caracteres, sem espaços.'));
email.addEventListener('input', () => validateField(email, isValidEmail, errE, okE, 'E-mail inválido.'));
password.addEventListener('input', () => {
  checkPwStrength(password.value);
  errP.textContent = password.value.length >= 8 ? '' : 'Mínimo de 8 caracteres.';
});
confirm.addEventListener('input', () => {
  errC.textContent = confirm.value === password.value ? '' : 'As senhas não conferem.';
});

// Botão de Olho (Mostrar/Ocultar Senha)
togglePw.addEventListener('click', () => {
  const type = password.type === 'password' ? 'text' : 'password';
  password.type = type;
  togglePw.className = type === 'password' ? 'fa-regular fa-eye icon-right' : 'fa-regular fa-eye-slash icon-right';
});

// SUBMIT DO FORMULÁRIO (CONEXÃO REAL COM BACKEND)
form.addEventListener('submit', async (e) => {
  e.preventDefault();
  
  // 1. Validação Final antes de enviar
  const uValid = isValidUsername(username.value);
  const eValid = isValidEmail(email.value);
  const pValid = password.value.length >= 8;
  const cValid = confirm.value === password.value && confirm.value.length > 0;

  if(!uValid || !eValid || !pValid || !cValid) {
    showToast('Verifique os campos em vermelho', 'error');
    if(!uValid) errU.textContent = 'Campo obrigatório';
    return;
  }

  // 2. Travar botão e mostrar Loading
  submitBtn.disabled = true;
  const originalLabel = submitBtn.innerHTML;
  submitBtn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Criando...';

  try {
    // 3. Montar Payload (JSON)
    const payload = {
      username: username.value.trim(),
      email: email.value.trim(),
      password: password.value,
      confirm: confirm.value
    };

    // 4. Envio REAL para o servidor
    const res = await fetch('/register', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
      credentials: 'same-origin',
      body: JSON.stringify(payload)
    });

    const data = await res.json().catch(()=>({}));

    // 5. Sucesso
    if(res.ok && data && data.ok){
      showToast('Conta criada com sucesso!', 'success');
      // Redireciona para o Dashboard (ou link enviado pelo server)
      setTimeout(()=>{ window.location.href = data.redirect || '/dashboard'; }, 900);
      return;
    }

    // 6. Erros do Backend (Usuário já existe, etc)
    if(data && data.field === 'username'){ errU.textContent = data.error || 'Erro no nome de usuário'; username.focus(); }
    else if(data && data.field === 'email'){ errE.textContent = data.error || 'Erro no e-mail'; email.focus(); }
    else if(data && data.field === 'password'){ errP.textContent = data.error || 'Erro na senha'; password.focus(); }
    else if(data && data.field === 'confirm'){ errC.textContent = data.error || 'Erro na confirmação'; confirm.focus(); }
    else if(res.status === 409){
      const msg = (data && data.error) || 'Usuário ou e-mail já cadastrado';
      errU.textContent = msg;
      errE.textContent = msg;
      showToast(msg, 'error');
    } else {
      showToast((data && data.error) || 'Não foi possível criar a conta', 'error');
    }

  } catch(err) {
    // 7. Erro de Rede
    showToast('Falha de conexão. Tente novamente.', 'error');
    console.error(err);
  } finally {
    // 8. Restaurar botão
    submitBtn.disabled = false;
    submitBtn.innerHTML = originalLabel;
  }
});
</script>
</body>
</html>
