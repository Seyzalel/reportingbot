<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="format-detection" content="telephone=no">
<title>Painel Administrador</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{--bg:#ffffff;--muted:#f4f6f8;--text:#0f172a;--sub:#475569;--line:#e5e7eb;--brand:#0ea5e9;--brand-2:#0284c7;--ok:#10b981;--warn:#f59e0b;--err:#ef4444;--card:#ffffff;--shadow:0 2px 10px rgba(0,0,0,.06);--radius:12px}
*{box-sizing:border-box}
html,body{height:100%}
html{-webkit-text-size-adjust:100%}
body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 "Inter",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;overflow-x:hidden;touch-action:manipulation}
.container{display:grid;grid-template-rows:auto 1fr auto;min-height:100dvh}
.topbar{position:sticky;top:0;z-index:20;display:flex;align-items:center;gap:16px;padding:12px 20px;border-bottom:1px solid var(--line);background:rgba(255,255,255,.9);backdrop-filter:saturate(180%) blur(8px)}
.brand{display:flex;align-items:center;gap:10px;font-weight:700;font-size:16px;letter-spacing:.2px}
.top-actions{margin-left:auto;display:flex;align-items:center;gap:12px}
.user-pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#fff;color:var(--sub)}
.btn{display:inline-grid;place-items:center;gap:8px;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;color:var(--text);cursor:pointer;transition:.15s;user-select:none;min-width:40px}
.btn:hover{box-shadow:var(--shadow);transform:translateY(-1px)}
.btn:active{transform:translateY(0)}
.btn.primary{border-color:transparent;background:var(--brand);color:#fff}
.btn.primary:hover{background:var(--brand-2)}
.btn.danger{border-color:transparent;background:var(--err);color:#fff}
.btn.ghost{background:transparent}
.tabs{display:flex;gap:6px;padding:12px 20px;border-bottom:1px solid var(--line);overflow:auto;scrollbar-width:none;-ms-overflow-style:none}
.tabs::-webkit-scrollbar{display:none}
.tab{padding:10px 12px;border-radius:10px;cursor:pointer;color:var(--sub);white-space:nowrap}
.tab.active{background:var(--muted);color:var(--text);font-weight:600}
.content{padding:clamp(12px,2vw,24px);max-width:1200px;margin:0 auto;width:100%}
.grid{display:grid;gap:16px}
.metrics{grid-template-columns:repeat(4,minmax(0,1fr))}
.card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
.kpi{display:flex;flex-direction:column;gap:8px}
.kpi .label{color:var(--sub);font-size:12px}
.kpi .value{font-size:22px;font-weight:700}
.kpi .sub{color:var(--sub);font-size:12px}
.section{display:flex;align-items:center;justify-content:space-between;margin:8px 0 16px}
.section h2{margin:0;font-size:16px}
.filters{display:flex;flex-wrap:wrap;gap:10px}
.input,select{height:38px;padding:0 12px;border:1px solid var(--line);border-radius:10px;background:#fff;color:var(--text);min-width:0}
.input::placeholder{color:#9aa3af}
.input:focus,select:focus{outline:none;border-color:var(--brand);box-shadow:0 0 0 3px rgba(14,165,233,.15)}
.switch{position:relative;width:42px;height:24px;border-radius:999px;background:#e5e7eb;cursor:pointer;display:inline-block;vertical-align:middle}
.switch[data-on="true"]{background:var(--brand)}
.switch i{position:absolute;top:3px;left:3px;width:18px;height:18px;border-radius:50%;background:#fff;transition:.2s}
.switch[data-on="true"] i{left:21px}
.table-wrap{width:100%;overflow:visible}
.table{width:100%;border-collapse:separate;border-spacing:0 10px}
.table thead th{font-size:12px;color:var(--sub);text-align:left;padding:0 12px}
.row{background:var(--card);border:1px solid var(--line);border-radius:12px;box-shadow:var(--shadow)}
.row td{padding:12px;vertical-align:top;word-break:break-word;overflow-wrap:anywhere}
.badge{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px;border:1px solid}
.badge.ok{color:var(--ok);border-color:var(--ok);background:rgba(16,185,129,.06)}
.badge.err{color:var(--err);border-color:var(--err);background:rgba(239,68,68,.06)}
.badge.neutral{color:var(--sub);border-color:var(--line);background:#fff}
.actions{display:flex;gap:8px;flex-wrap:wrap}
.pagination{display:flex;align-items:center;gap:8px;justify-content:flex-end;padding-top:8px}
.modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.4);z-index:50;padding:20px}
.modal.open{display:grid}
.modal .box{width:min(520px,92vw);background:#fff;border-radius:14px;border:1px solid var(--line);box-shadow:0 20px 60px rgba(0,0,0,.15);padding:16px}
.modal .box h3{margin:0 0 8px 0;font-size:16px}
.modal .body{display:grid;gap:10px;margin:10px 0}
.modal .foot{display:flex;gap:10px;justify-content:flex-end}
.inline{display:flex;align-items:center;gap:8px}
.help{font-size:12px;color:var(--sub)}
.toast-area{position:fixed;right:16px;bottom:16px;display:grid;gap:8px;z-index:60}
.toast{background:#111827;color:#fff;padding:10px 12px;border-radius:10px;box-shadow:var(--shadow);display:flex;align-items:center;gap:10px;opacity:.98}
hr.sep{border:none;height:1px;background:var(--line);margin:6px 0 12px}
.small{font-size:12px;color:var(--sub)}
table.min{width:100%;border-collapse:collapse}
table.min td{padding:6px 0}
.field{display:grid;gap:6px}
.currency{position:relative}
.currency input{padding-left:34px}
.currency span{position:absolute;left:10px;top:9px;color:var(--sub);font-size:12px}
.tag{display:inline-block;background:var(--muted);border:1px solid var(--line);padding:3px 8px;border-radius:999px;font-size:12px;color:var(--sub)}
.footer{display:flex;align-items:center;justify-content:center;gap:10px;padding:14px 16px;border-top:1px solid var(--line);background:#fff}
.footer .mark{display:grid;place-items:center;width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,var(--brand),var(--brand-2));color:#fff}
.footer .copy{font-size:13px;color:var(--sub)}
@media (max-width:1100px){.metrics{grid-template-columns:repeat(3,minmax(0,1fr))}}
@media (max-width:900px){.metrics{grid-template-columns:repeat(2,minmax(0,1fr))}}
@media (max-width:640px){
body{font-size:13px}
.metrics{grid-template-columns:1fr}
.filters{flex-direction:column;align-items:stretch}
.top-actions{display:none}
.row td{padding:10px}
.kpi .value{font-size:20px}
.table thead{display:none}
.table{border-spacing:0 8px}
.row{display:block}
.row td{display:grid;grid-template-columns:110px 1fr;gap:6px;align-items:center}
.row td::before{content:attr(data-label);font-size:12px;color:var(--sub)}
}
</style>
</head>
<body>
<div class="container">
<div class="topbar">
<div class="brand">Admin</div>
<div class="tabs" id="tabs">
<div class="tab active" data-tab="overview">Visão Geral</div>
<div class="tab" data-tab="transactions">Transações</div>
<div class="tab" data-tab="users">Usuários</div>
<div class="tab" data-tab="plans">Planos</div>
</div>
<div class="top-actions">
<div class="user-pill">Olá, {{ username }}</div>
<a class="btn" href="/logout">Sair</a>
</div>
</div>
<div class="content">
<div id="overview" class="grid">
<div class="section"><h2>Métricas</h2><div class="inline"><button class="btn" id="refreshOverview">Atualizar</button><label class="inline small">Auto</label><div class="switch" id="autoOverview" data-on="false"><i></i></div></div></div>
<div class="grid metrics">
<div class="card kpi"><div class="label">Receita Hoje</div><div class="value" id="revToday">R$ 0,00</div><div class="sub"><span id="countToday">0</span> ativações</div></div>
<div class="card kpi"><div class="label">Receita 7 dias</div><div class="value" id="rev7d">R$ 0,00</div><div class="sub"><span id="count7d">0</span> ativações</div></div>
<div class="card kpi"><div class="label">Receita 30 dias</div><div class="value" id="rev30d">R$ 0,00</div><div class="sub"><span id="count30d">0</span> ativações</div></div>
<div class="card kpi"><div class="label">Transações</div><div class="value"><span class="tag" id="txPending">0 pendentes</span> <span class="tag" id="txPaid">0 pagas</span> <span class="tag" id="txFailed">0 falhas</span></div></div>
</div>
</div>
<div id="transactions" class="grid" style="display:none">
<div class="section"><h2>Transações</h2><div class="inline"><button class="btn" id="refreshTx">Atualizar</button><label class="inline small">Auto</label><div class="switch" id="autoTx" data-on="false"><i></i></div></div></div>
<div class="card">
<div class="filters">
<input class="input" id="txQ" placeholder="Buscar por hash ou usuário">
<select id="txStatus">
<option value="">Status: Todos</option>
<option value="paid">Pagas</option>
<option value="failed">Falhas</option>
<option value="pending">Pendentes</option>
</select>
<select id="txPlan">
<option value="">Plano: Todos</option>
<option>Essencial</option>
<option>Profissional</option>
<option>Vitalício</option>
</select>
<input class="input" id="txFrom" type="datetime-local" placeholder="De">
<input class="input" id="txTo" type="datetime-local" placeholder="Até">
<select id="txSize">
<option value="10">10 por página</option>
<option value="20" selected>20 por página</option>
<option value="50">50 por página</option>
<option value="100">100 por página</option>
</select>
<button class="btn primary" id="applyTx">Aplicar</button>
<button class="btn" id="resetTx">Limpar</button>
</div>
<hr class="sep">
<div class="table-wrap">
<table class="table">
<thead><tr><th>Data</th><th>Usuário</th><th>Plano</th><th>Valor</th><th>Status</th><th>Ativada</th><th>Falha</th><th>Hash</th><th>Ações</th></tr></thead>
<tbody id="txBody"></tbody>
</table>
</div>
<div class="pagination">
<button class="btn" id="txPrev">Anterior</button>
<div class="small" id="txPageInfo"></div>
<button class="btn" id="txNext">Próxima</button>
</div>
</div>
</div>
<div id="users" class="grid" style="display:none">
<div class="section"><h2>Usuários</h2><div class="inline"><button class="btn" id="refreshUsers">Atualizar</button></div></div>
<div class="card">
<div class="filters">
<input class="input" id="uQ" placeholder="Buscar por nome ou e-mail">
<select id="uAdmin">
<option value="">Admin: Todos</option>
<option value="yes">Somente admin</option>
<option value="no">Somente não admin</option>
</select>
<select id="uDisabled">
<option value="">Status: Todos</option>
<option value="false">Ativos</option>
<option value="true">Desabilitados</option>
</select>
<select id="uSize">
<option value="10">10 por página</option>
<option value="20" selected>20 por página</option>
<option value="50">50 por página</option>
<option value="100">100 por página</option>
</select>
<button class="btn primary" id="applyUsers">Aplicar</button>
<button class="btn" id="resetUsers">Limpar</button>
</div>
<hr class="sep">
<div class="table-wrap">
<table class="table">
<thead><tr><th>Usuário</th><th>Email</th><th>Plano</th><th>Início</th><th>Expira</th><th>Admin</th><th>Desabilitado</th><th>Criado</th><th>Login</th><th>Ações</th></tr></thead>
<tbody id="uBody"></tbody>
</table>
</div>
<div class="pagination">
<button class="btn" id="uPrev">Anterior</button>
<div class="small" id="uPageInfo"></div>
<button class="btn" id="uNext">Próxima</button>
</div>
</div>
</div>
<div id="plans" class="grid" style="display:none">
<div class="section"><h2>Planos</h2><div class="inline"><button class="btn" id="refreshPlans">Atualizar</button></div></div>
<div class="card">
<div id="plansForm" class="grid" style="grid-template-columns:repeat(3,minmax(0,1fr))"></div>
<hr class="sep">
<div class="inline" style="justify-content:flex-end"><button class="btn primary" id="savePlans" disabled>Salvar alterações</button></div>
</div>
</div>
</div>
<footer class="footer">
<div class="mark">
<svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M12 2l3.09 6.26L22 9.27l-5 4.82L18.18 22 12 18.77 5.82 22 7 14.09l-5-4.82 6.91-1.01L12 2z" fill="currentColor"/></svg>
</div>
<div class="copy">© 2025 Seyzalel — Todos os direitos reservados</div>
</footer>
</div>
<div class="modal" id="modalTx">
<div class="box">
<h3>Editar Transação</h3>
<div class="body">
<div class="small" id="modalTxHash"></div>
<div class="field">
<label class="small">Status do pagamento</label>
<select id="modalTxStatus">
<option value="">Selecionar</option>
<option value="paid">paid</option>
<option value="approved">approved</option>
<option value="completed">completed</option>
<option value="confirmed">confirmed</option>
<option value="paid_out">paid_out</option>
<option value="finished">finished</option>
<option value="success">success</option>
<option value="settled">settled</option>
<option value="captured">captured</option>
<option value="accredited">accredited</option>
<option value="credited">credited</option>
<option value="confirmed_payment">confirmed_payment</option>
<option value="canceled">canceled</option>
<option value="cancelled">cancelled</option>
<option value="refunded">refunded</option>
<option value="chargeback">chargeback</option>
<option value="reversed">reversed</option>
<option value="voided">voided</option>
<option value="failed">failed</option>
<option value="expired">expired</option>
<option value="denied">denied</option>
</select>
</div>
<div class="field">
<label class="small">Ou digite um status</label>
<input class="input" id="modalTxCustom" placeholder="ex.: paid">
</div>
</div>
<div class="foot">
<button class="btn" id="modalTxClose">Cancelar</button>
<button class="btn primary" id="modalTxSave">Salvar</button>
</div>
</div>
</div>
<div class="modal" id="modalConfirm">
<div class="box">
<h3 id="confirmTitle"></h3>
<div class="body"><div id="confirmMsg"></div></div>
<div class="foot">
<button class="btn" id="confirmCancel">Cancelar</button>
<button class="btn danger" id="confirmOk">Confirmar</button>
</div>
</div>
</div>
<div class="toast-area" id="toasts"></div>
<script>
const PAID=["paid","approved","completed","confirmed","paid_out","finished","success","settled","captured","accredited","credited","confirmed_payment"]
const FAILED=["canceled","cancelled","refunded","chargeback","reversed","voided","failed","expired","denied"]
const fmtBRL=v=>new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format((Number(v||0)/100)||0)
const fmtDate=s=>s?new Date(s).toLocaleString("pt-BR"):"—"
const el=q=>document.querySelector(q)
const els=q=>Array.from(document.querySelectorAll(q))
const toast=(t,m)=>{const n=document.createElement("div");n.className="toast";n.textContent=m;el("#toasts").appendChild(n);setTimeout(()=>n.remove(),3500)}
const fetchJSON=async(u,o={})=>{const r=await fetch(u,{credentials:"same-origin",headers:{"Content-Type":"application/json"},...o});let j=null;try{j=await r.json()}catch(e){}if(!r.ok){throw j||{ok:false}}return j}
const setSwitch=(e,v)=>{e.setAttribute("data-on",v?"true":"false")}
const getSwitch=e=>e.getAttribute("data-on")==="true"
let autoOverviewTimer=null,autoTxTimer=null,lastTouchEnd=0
document.addEventListener("gesturestart",e=>e.preventDefault(),{passive:false})
document.addEventListener("dblclick",e=>e.preventDefault(),{passive:false})
document.addEventListener("touchend",e=>{const now=Date.now();if(now-lastTouchEnd<=300)e.preventDefault();lastTouchEnd=now},{passive:false})
els(".tab").forEach(t=>t.addEventListener("click",()=>{els(".tab").forEach(x=>x.classList.remove("active"));t.classList.add("active");["overview","transactions","users","plans"].forEach(id=>el("#"+id).style.display="none");el("#"+t.dataset.tab).style.display="grid"}))
el("#refreshOverview").addEventListener("click",()=>loadOverview())
el("#autoOverview").addEventListener("click",()=>{const on=!getSwitch(el("#autoOverview"));setSwitch(el("#autoOverview"),on);if(on){autoOverviewTimer=setInterval(loadOverview,8000);loadOverview()}else{clearInterval(autoOverviewTimer)}})
async function loadOverview(){try{const d=await fetchJSON("/admin/api/metrics");el("#revToday").textContent=fmtBRL(d.revenue_today_cents);el("#rev7d").textContent=fmtBRL(d.revenue_7d_cents);el("#rev30d").textContent=fmtBRL(d.revenue_30d_cents);el("#countToday").textContent=d.count_today;el("#count7d").textContent=d.count_7d;el("#count30d").textContent=d.count_30d;el("#txPending").textContent=(d.tx_counts.pending||0)+" pendentes";el("#txPaid").textContent=(d.tx_counts.paid||0)+" pagas";el("#txFailed").textContent=(d.tx_counts.failed||0)+" falhas"}catch(e){toast("err","Falha ao carregar métricas")}}
let txState={page:1,size:20,status:"",plan:"",q:"",from:"",to:""}
const txStatusSel=el("#txStatus")
const txPlanSel=el("#txPlan")
const txQ=el("#txQ")
const txFrom=el("#txFrom")
const txTo=el("#txTo")
const txSize=el("#txSize")
const txBody=el("#txBody")
const txPageInfo=el("#txPageInfo")
el("#applyTx").addEventListener("click",()=>{txState.page=1;applyTxFilters()})
el("#resetTx").addEventListener("click",()=>{txQ.value="";txStatusSel.value="";txPlanSel.value="";txFrom.value="";txTo.value="";txSize.value="20";txState={page:1,size:20,status:"",plan:"",q:"",from:"",to:""};loadTx()})
el("#txPrev").addEventListener("click",()=>{if(txState.page>1){txState.page--;loadTx()}})
el("#txNext").addEventListener("click",()=>{txState.page++;loadTx()})
el("#refreshTx").addEventListener("click",()=>loadTx())
el("#autoTx").addEventListener("click",()=>{const on=!getSwitch(el("#autoTx"));setSwitch(el("#autoTx"),on);if(on){autoTxTimer=setInterval(loadTx,8000);loadTx()}else{clearInterval(autoTxTimer)}})
function applyTxFilters(){txState.size=Number(txSize.value);txState.status=txStatusSel.value;txState.plan=txPlanSel.value;txState.q=txQ.value.trim();txState.from=txFrom.value;txState.to=txTo.value;loadTx()}
function statusBadge(s){if(!s)return'<span class="badge neutral">—</span>';const cls=PAID.includes(s)?'ok':FAILED.includes(s)?'err':'neutral';return `<span class="badge ${cls}">${s}</span>`}
async function loadTx(){try{const params=new URLSearchParams();params.set("page",String(txState.page));params.set("page_size",String(txState.size));if(txState.q)params.set("q",txState.q);if(txState.plan)params.set("plan",txState.plan);if(txState.status&&txState.status!=="pending"){params.set("status",txState.status)}if(txState.from)params.set("from",txState.from);if(txState.to)params.set("to",txState.to);const d=await fetchJSON(`/admin/api/transactions?${params.toString()}`);let items=d.items||[];if(txState.status==="pending"){items=items.filter(it=>!PAID.includes(it.payment_status)&&!FAILED.includes(it.payment_status))}txBody.innerHTML="";items.forEach(it=>{const tr=document.createElement("tr");tr.className="row";tr.innerHTML=`<td data-label="Data">${fmtDate(it.created_at)}</td><td data-label="Usuário">${it.username||"—"}</td><td data-label="Plano">${it.plan||"—"}</td><td data-label="Valor">${fmtBRL(it.amount_cents||0)}</td><td data-label="Status">${statusBadge(it.payment_status)}</td><td data-label="Ativada">${fmtDate(it.activated_at)}</td><td data-label="Falha">${fmtDate(it.failed_at)}</td><td data-label="Hash" class="small" style="max-width:200px;word-break:break-all">${it.hash||"—"}</td><td data-label="Ações"><div class="actions"><button class="btn" data-edit="${it.id}">Editar</button><button class="btn danger" data-del="${it.id}" data-hash="${it.hash||""}">Excluir</button></div></td>`;txBody.appendChild(tr)});const shownStart=(d.page-1)*d.page_size+1;const shownEnd=Math.min(d.page*d.page_size,d.total);txPageInfo.textContent=txState.status==="pending"?`Pendentes filtrados nesta página: ${items.length}`:(d.total?`Mostrando ${shownStart}–${shownEnd} de ${d.total}`:"Nenhum resultado");txState.total=d.total;els('[data-edit]').forEach(b=>b.onclick=()=>openEditTx(b.getAttribute('data-edit')));els('[data-del]').forEach(b=>b.onclick=()=>confirmDeleteTx(b.getAttribute('data-del'),b.getAttribute('data-hash')))}catch(e){toast("err","Falha ao carregar transações")}}
let editTxId=null
function openEditTx(id){editTxId=id;el("#modalTxStatus").value="";el("#modalTxCustom").value="";const row=el(`[data-del="${id}"]`)?.closest("tr");const h=row?row.children[7].textContent.trim():"";el("#modalTxHash").textContent=h?`Hash: ${h}`:"";openModal("modalTx")}
el("#modalTxClose").addEventListener("click",()=>closeModal("modalTx"))
el("#modalTxSave").addEventListener("click",async()=>{try{const s=el("#modalTxCustom").value.trim()||el("#modalTxStatus").value.trim();if(!s){toast("err","Informe um status");return}await fetchJSON(`/admin/api/transactions/${editTxId}`,{method:"PATCH",body:JSON.stringify({payment_status:s})});closeModal("modalTx");toast("ok","Transação atualizada");loadTx()}catch(e){toast("err","Falha ao atualizar transação")}})
function confirmDeleteTx(id,hash){openConfirm("Excluir transação",`Deseja excluir a transação ${hash||id}?`,async()=>{try{await fetchJSON(`/admin/api/transactions/${id}`,{method:"DELETE"});toast("ok","Transação excluída");loadTx()}catch(e){toast("err","Falha ao excluir transação")}})}
let uState={page:1,size:20,q:"",admin:"",disabled:""}
const uQ=el("#uQ"),uAdmin=el("#uAdmin"),uDisabled=el("#uDisabled"),uSize=el("#uSize"),uBody=el("#uBody"),uPageInfo=el("#uPageInfo")
el("#applyUsers").addEventListener("click",()=>{uState.page=1;applyUFilters()})
el("#resetUsers").addEventListener("click",()=>{uQ.value="";uAdmin.value="";uDisabled.value="";uSize.value="20";uState={page:1,size:20,q:"",admin:"",disabled:""};loadUsers()})
el("#uPrev").addEventListener("click",()=>{if(uState.page>1){uState.page--;loadUsers()}})
el("#uNext").addEventListener("click",()=>{uState.page++;loadUsers()})
el("#refreshUsers").addEventListener("click",()=>loadUsers())
function applyUFilters(){uState.size=Number(uSize.value);uState.q=uQ.value.trim();uState.admin=uAdmin.value;uState.disabled=uDisabled.value;loadUsers()}
async function loadUsers(){try{const params=new URLSearchParams();params.set("page",String(uState.page));params.set("page_size",String(uState.size));if(uState.q)params.set("q",uState.q);if(uState.admin)params.set("admin",uState.admin);if(uState.disabled)params.set("disabled",uState.disabled);const d=await fetchJSON(`/admin/api/users?${params.toString()}`);uBody.innerHTML="";d.items.forEach(u=>{const tr=document.createElement("tr");tr.className="row";tr.innerHTML=`<td data-label="Usuário">${u.username}</td><td data-label="Email">${u.email||"—"}</td><td data-label="Plano">${u.plans||"—"}</td><td data-label="Início">${fmtDate(u.plan_started_at)}</td><td data-label="Expira">${fmtDate(u.plan_expires_at)}</td><td data-label="Admin">${u.admin_permission==="yes"?'<span class="badge ok">yes</span>':'<span class="badge neutral">no</span>'}</td><td data-label="Desabilitado">${u.disabled?'<span class="badge err">true</span>':'<span class="badge neutral">false</span>'}</td><td data-label="Criado">${fmtDate(u.created_at)}</td><td data-label="Login">${fmtDate(u.last_login_at)}</td><td data-label="Ações"><div class="actions"><button class="btn" data-admin="${u.id}" data-val="${u.admin_permission==="yes"?"no":"yes"}">${u.admin_permission==="yes"?"Revogar":"Tornar admin"}</button><button class="btn" data-disable="${u.id}" data-val="${!u.disabled}">${u.disabled?"Reativar":"Desabilitar"}</button><button class="btn" data-logout="${u.id}">Forçar logout</button></div></td>`;uBody.appendChild(tr)});const shownStart=(d.page-1)*d.page_size+1;const shownEnd=Math.min(d.page*d.page_size,d.total);uPageInfo.textContent=d.total?`Mostrando ${shownStart}–${shownEnd} de ${d.total}`:"Nenhum resultado";els('[data-admin]').forEach(b=>b.onclick=()=>toggleAdmin(b.getAttribute("data-admin"),b.getAttribute("data-val")));els('[data-disable]').forEach(b=>b.onclick=()=>toggleDisable(b.getAttribute("data-disable"),b.getAttribute("data-val")==="true"));els('[data-logout]').forEach(b=>b.onclick=()=>forceLogout(b.getAttribute("data-logout")))}catch(e){toast("err","Falha ao carregar usuários")}}
async function toggleAdmin(id,val){try{await fetchJSON(`/admin/api/users/${id}/set_admin`,{method:"POST",body:JSON.stringify({admin_permission:val})});toast("ok","Permissão atualizada");loadUsers()}catch(e){toast("err","Falha ao atualizar permissão")}}
async function toggleDisable(id,val){try{await fetchJSON(`/admin/api/users/${id}/disable`,{method:"POST",body:JSON.stringify({disabled:val})});toast("ok","Status atualizado");loadUsers()}catch(e){toast("err","Falha ao atualizar status")}}
async function forceLogout(id){try{await fetchJSON(`/admin/api/users/${id}/force_logout`,{method:"POST"});toast("ok","Logout forçado")}catch(e){toast("err","Falha ao forçar logout")}}
let plansCache=null,plansDirty={}
const plansForm=el("#plansForm")
el("#refreshPlans").addEventListener("click",()=>loadPlans())
el("#savePlans").addEventListener("click",()=>savePlans())
function centsFromBRL(str){const n=String(str||"").replace(/[^\d,.-]/g,"").replace(/\./g,"").replace(",",".");const v=Number(n||0);return Math.round(v*100)}
function brlFromCents(c){return fmtBRL(c)}
function planCard(name,p){const wrap=document.createElement("div");wrap.className="card";wrap.innerHTML=`<div class="inline" style="justify-content:space-between"><div style="font-weight:700">${p.title}</div><span class="tag">${name}</span></div><hr class="sep"><table class="min"><tr><td class="small">Produto</td><td class="small" style="text-align:right">${p.product_hash}</td></tr><tr><td class="small">Oferta</td><td class="small" style="text-align:right">${p.offer_hash}</td></tr></table><div class="field currency" style="margin-top:10px"><label class="small">Preço</label><span>R$</span><input class="input" inputmode="decimal" value="${(p.amount_cents/100).toFixed(2).replace(".",",")}" data-plan="${name}" data-field="amount_cents"></div><div class="field" style="margin-top:10px"><label class="small">Ativo</label><div class="switch" data-plan="${name}" data-field="active" data-on="${p.active?'true':'false'}"><i></i></div></div>`;return wrap}
async function loadPlans(){try{const d=await fetchJSON("/admin/api/plans");plansCache=d.plans;plansDirty={};plansForm.innerHTML="";Object.keys(d.plans).forEach(k=>{plansForm.appendChild(planCard(k,d.plans[k]))});els('#plansForm input[data-field="amount_cents"]').forEach(i=>i.addEventListener("input",()=>markPlanDirty(i.getAttribute("data-plan"))));els('#plansForm .switch[data-field="active"]').forEach(sw=>sw.addEventListener("click",()=>{const on=sw.getAttribute("data-on")==="true";sw.setAttribute("data-on",on?"false":"true");markPlanDirty(sw.getAttribute("data-plan"))}));setSaveEnabled()}catch(e){toast("err","Falha ao carregar planos")}}
function markPlanDirty(name){plansDirty[name]=true;setSaveEnabled()}
function setSaveEnabled(){el("#savePlans").disabled=Object.keys(plansDirty).length===0}
async function savePlans(){try{const payload={};Object.keys(plansDirty).forEach(name=>{const priceEl=el(`#plansForm input[data-plan="${name}"][data-field="amount_cents"]`);const sw=el(`#plansForm .switch[data-plan="${name}"][data-field="active"]`);const cents=centsFromBRL(priceEl.value);const active=sw.getAttribute("data-on")==="true";payload[name]={amount_cents:cents,active:active}});await fetchJSON("/admin/api/plans",{method:"PUT",body:JSON.stringify(payload)});plansDirty={};setSaveEnabled();toast("ok","Planos atualizados");loadPlans()}catch(e){toast("err","Falha ao salvar planos")}}
function openModal(id){el("#"+id).classList.add("open")}
function closeModal(id){el("#"+id).classList.remove("open")}
let confirmCb=null
function openConfirm(title,msg,cb){el("#confirmTitle").textContent=title;el("#confirmMsg").textContent=msg;confirmCb=cb;openModal("modalConfirm")}
el("#confirmCancel").addEventListener("click",()=>{confirmCb=null;closeModal("modalConfirm")})
el("#confirmOk").addEventListener("click",async()=>{const cb=confirmCb;confirmCb=null;closeModal("modalConfirm");if(cb)await cb()})
window.addEventListener("load",()=>{loadOverview();loadTx();loadUsers();loadPlans()})
</script>
</body>
</html>