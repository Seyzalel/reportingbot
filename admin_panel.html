<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="color-scheme" content="light">
<title>Painel Administrativo</title>
<style>
*{box-sizing:border-box}html,body{height:100%}body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,Ubuntu,"Helvetica Neue",Arial;line-height:1.45;background:#f7f8fa;color:#0e1117;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
:root{--bg:#f7f8fa;--card:#ffffff;--text:#0e1117;--muted:#5b6573;--brand:#0ea5e9;--accent:#111827;--border:#e5e7eb;--success:#10b981;--danger:#ef4444;--warning:#f59e0b;--shadow:0 1px 2px rgba(0,0,0,.04),0 6px 24px rgba(0,0,0,.06)}
.layout{display:grid;grid-template-columns:280px 1fr;min-height:100vh}
@media(max-width:1000px){.layout{grid-template-columns:1fr}}
.sidebar{position:sticky;top:0;align-self:start;height:100vh;background:#ffffff;border-right:1px solid var(--border);display:flex;flex-direction:column;padding:20px;gap:16px}
@media(max-width:1000px){.sidebar{position:fixed;z-index:30;left:0;top:0;width:280px;transform:translateX(-100%);transition:transform .25s ease;height:100vh}.sidebar.open{transform:translateX(0)}}
.nav{display:flex;flex-direction:column;gap:6px;margin-top:8px}
.nav button{all:unset;display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:10px;cursor:pointer;color:var(--muted)}
.nav button[aria-current="page"]{background:#f0f9ff;color:#0369a1}
.nav svg{width:18px;height:18px}
.userbox{margin-top:auto;padding-top:12px;border-top:1px solid var(--border);color:var(--muted);font-size:14px}
.main{min-width:0}
.topbar{position:sticky;top:0;z-index:20;background:rgba(255,255,255,.8);backdrop-filter:saturate(180%) blur(12px);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;padding:12px}
.topbar .menu{display:none}
@media(max-width:1000px){.topbar .menu{display:inline-flex}}
.topbar .spacer{flex:1}
.btn{all:unset;display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:10px;background:#111827;color:#fff;cursor:pointer}
.btn.secondary{background:#eef2f7;color:#0e1117}
.btn.ghost{background:transparent;color:#0e1117;border:1px solid var(--border)}
.btn.success{background:#ecfdf5;color:#065f46}
.btn.warn{background:#fffbeb;color:#92400e}
.btn.danger{background:#fef2f2;color:#991b1b}
.btn.small{padding:6px 8px;font-size:12px;border-radius:8px}
.btn svg{width:18px;height:18px}
.kpis{display:grid;grid-template-columns:repeat(12,1fr);gap:16px;padding:16px}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:16px;min-width:0}
.kpi{grid-column:span 3}
@media(max-width:1200px){.kpi{grid-column:span 6}}
@media(max-width:700px){.kpi{grid-column:span 12}}
.kpi .label{color:var(--muted);font-size:13px}
.kpi .value{font-size:28px;font-weight:700;margin-top:4px}
.kpi .sub{margin-top:8px;color:var(--muted);font-size:12px}
.section{padding:0 16px 24px}
.toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:end;margin-bottom:12px}
.input,select{height:38px;border:1px solid var(--border);border-radius:10px;padding:0 12px;background:#fff;color:var(--text);min-width:0}
.input:disabled,select:disabled{opacity:.6}
.field{display:flex;flex-direction:column;gap:6px}
label{font-size:12px;color:var(--muted)}
.tablewrap{overflow:auto;border-radius:14px;border:1px solid var(--border);background:#fff}
table{width:100%;border-collapse:separate;border-spacing:0;min-width:900px}
thead th{position:sticky;top:0;background:#fafafa;border-bottom:1px solid var(--border);font-size:12px;color:var(--muted);text-align:left;padding:12px}
tbody td{padding:12px;border-bottom:1px solid var(--border);vertical-align:middle;font-size:14px}
tr:hover td{background:#fcfdff}
.badge{display:inline-flex;align-items:center;gap:6px;border-radius:999px;padding:4px 8px;font-size:12px}
.badge.paid{background:#ecfdf5;color:#065f46}
.badge.failed{background:#fef2f2;color:#991b1b}
.badge.pending{background:#f1f5f9;color:#0f172a}
.pills{display:flex;gap:8px;flex-wrap:wrap}
.pill{border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-size:12px;color:var(--muted)}
.rowactions{display:flex;gap:6px;flex-wrap:wrap}
.iconbtn{all:unset;display:inline-grid;place-items:center;width:32px;height:32px;border-radius:10px;border:1px solid var(--border);cursor:pointer;background:#fff}
.iconbtn.success{border-color:rgba(16,185,129,.25);background:#ecfdf5}
.iconbtn.warn{border-color:rgba(245,158,11,.25);background:#fffbeb}
.iconbtn.danger{border-color:rgba(239,68,68,.25);background:#fef2f2}
.iconbtn svg{width:16px;height:16px}
.pagination{display:flex;gap:8px;align-items:center;justify-content:flex-end;margin-top:12px}
.switch{position:relative;display:inline-block;width:44px;height:26px}
.switch input{opacity:0;width:0;height:0}
.slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#e5e7eb;border-radius:999px;transition:.2s}
.slider:before{position:absolute;content:"";height:20px;width:20px;left:3px;top:3px;background:white;border-radius:50%;transition:.2s;box-shadow:0 1px 2px rgba(0,0,0,.2)}
.switch input:checked+.slider{background:#34d399}
.switch input:checked+.slider:before{transform:translateX(18px)}
.grid{display:grid;gap:16px}
.grid.cols-2{grid-template-columns:repeat(2,1fr)}
@media(max-width:900px){.grid.cols-2{grid-template-columns:1fr}}
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;padding:16px;z-index:40}
.modal.open{display:flex}
.modal .overlay{position:absolute;inset:0;background:rgba(0,0,0,.35)}
.modal .dialog{position:relative;background:#fff;border-radius:16px;border:1px solid var(--border);box-shadow:var(--shadow);padding:16px;max-width:720px;width:100%}
.modal .head{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.toast{position:fixed;right:16px;bottom:16px;display:grid;gap:8px;z-index:50}
.toast .msg{background:#111827;color:#fff;border-radius:12px;padding:10px 12px;box-shadow:var(--shadow);font-size:14px}
.loader{width:18px;height:18px;border-radius:50%;border:2px solid #cfd8e3;border-top-color:#111827;animation:spin .7s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.skeleton{display:block;background:linear-gradient(90deg,#f2f4f7, #eef1f6 40%, #f2f4f7 60%);background-size:200% 100%;animation:shine 1.2s infinite}
@keyframes shine{to{background-position-x:-200%}}
.hidden{display:none}
.small{font-size:12px;color:var(--muted)}
hr{border:none;border-top:1px solid var(--border);margin:12px 0}
button:focus,select:focus,input:focus{outline:2px solid #93c5fd;outline-offset:2px;border-color:#93c5fd}
.sectiontitle{font-weight:700;margin:4px 0 8px 0}
.kv{display:grid;grid-template-columns:180px 1fr;gap:6px;align-items:center}
.kv div{padding:6px 8px;border:1px solid var(--border);border-radius:8px;background:#fff}
pre{white-space:pre-wrap;word-break:break-word;background:#f8fafc;border:1px solid var(--border);border-radius:12px;padding:12px;font-size:12px;margin:0}
</style>
</head>
<body>
<div class="layout">
<aside class="sidebar" id="sidebar" aria-label="Menu lateral">
<div class="nav" role="tablist" aria-orientation="vertical">
<button id="nav-dashboard" role="tab" aria-controls="tab-dashboard" aria-selected="true" aria-current="page"><svg viewBox="0 0 24 24" fill="none"><path d="M3 12h7V3H3v9ZM14 21h7v-9h-7v9ZM3 21h7v-6H3v6ZM14 10h7V3h-7v7Z" stroke="currentColor" stroke-width="1.5"/></svg>Visão geral</button>
<button id="nav-trans" role="tab" aria-controls="tab-trans" aria-selected="false"><svg viewBox="0 0 24 24" fill="none"><path d="M4 7h16M4 12h16M4 17h16" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>Transações</button>
<button id="nav-users" role="tab" aria-controls="tab-users" aria-selected="false"><svg viewBox="0 0 24 24" fill="none"><path d="M16 7a4 4 0 1 1-8 0 4 4 0 0 1 8 0Zm5 14a7 7 0 0 0-14 0" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>Usuários</button>
<button id="nav-plans" role="tab" aria-controls="tab-plans" aria-selected="false"><svg viewBox="0 0 24 24" fill="none"><path d="M4 7a2 2 0 0 1 2-2h5m9 12a2 2 0 0 1-2 2h-5M9 5v14m6-14v14" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>Planos</button>
</div>
<div class="userbox">
<div class="small">Conectado como</div>
<div><strong>{{ username }}</strong></div>
</div>
</aside>
<main class="main">
<div class="topbar">
<button class="btn ghost" aria-label="Abrir menu" id="btnMenu"><svg viewBox="0 0 24 24" fill="none"><path d="M4 7h16M4 12h16M4 17h16" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/></svg><span>Menu</span></button>
<div class="spacer"></div>
<button class="btn secondary" id="btnRefresh"><svg viewBox="0 0 24 24" fill="none"><path d="M21 12a9 9 0 1 1-2.64-6.36M21 4v6h-6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg><span>Atualizar</span></button>
<div class="pills"><span class="pill" id="lastSync">Sincronizando…</span>
<label class="pill" style="display:inline-flex;align-items:center;gap:8px">Auto<span class="switch"><input type="checkbox" id="autoTick" checked><span class="slider"></span></span></label></div>
</div>

<section id="tab-dashboard" role="tabpanel" aria-labelledby="nav-dashboard">
<div class="kpis">
<div class="card kpi"><div class="label">Receita hoje</div><div class="value" id="kpiToday" aria-live="polite">—</div><div class="sub" id="kpiTodayCount">—</div></div>
<div class="card kpi"><div class="label">Receita 7 dias</div><div class="value" id="kpi7d">—</div><div class="sub" id="kpi7dCount">—</div></div>
<div class="card kpi"><div class="label">Receita 30 dias</div><div class="value" id="kpi30d">—</div><div class="sub" id="kpi30dCount">—</div></div>
<div class="card kpi"><div class="label">Transações</div><div class="value" id="kpiTx">—</div><div class="sub" id="kpiSplit">—</div></div>
</div>
<div class="section">
<div class="card">
<div class="grid cols-2">
<div>
<div class="label">Status agregado</div>
<div class="pills" id="aggPills"></div>
</div>
<div>
<div class="label">Ações rápidas</div>
<div class="pills">
<button class="btn ghost" id="goTrans"><svg viewBox="0 0 24 24" fill="none"><path d="M4 7h16M4 12h16M4 17h16" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>Ver transações</button>
<button class="btn ghost" id="goUsers"><svg viewBox="0 0 24 24" fill="none"><path d="M16 7a4 4 0 1 1-8 0 4 4 0 0 1 8 0Zm5 14a7 7 0 0 0-14 0" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>Ver usuários</button>
<button class="btn ghost" id="goPlans"><svg viewBox="0 0 24 24" fill="none"><path d="M4 7a2 2 0 0 1 2-2h5m9 12a2 2 0 0 1-2 2h-5M9 5v14m6-14v14" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>Gerir planos</button>
</div>
</div>
</div>
</div>
</div>
</section>

<section id="tab-trans" class="hidden" role="tabpanel" aria-labelledby="nav-trans">
<div class="section">
<div class="card">
<div class="toolbar">
<div class="field"><label>Status</label><select id="fStatus"><option value="">Todos</option><option value="paid">Pago</option><option value="approved">Aprovado</option><option value="completed">Concluído</option><option value="confirmed">Confirmado</option><option value="pending">Pendente</option><option value="failed">Falhou</option><option value="canceled">Cancelado</option><option value="refunded">Estornado</option><option value="expired">Expirado</option></select></div>
<div class="field"><label>Plano</label><select id="fPlan"><option value="">Todos</option><option>Essencial</option><option>Profissional</option><option>Vitalício</option></select></div>
<div class="field"><label>De</label><input id="fFrom" type="datetime-local" class="input"></div>
<div class="field"><label>Até</label><input id="fTo" type="datetime-local" class="input"></div>
<div class="field" style="min-width:220px"><label>Busca</label><input id="fQ" type="search" class="input" placeholder="hash ou usuário"></div>
<div class="field"><label>Tamanho</label><select id="fPageSize"><option>20</option><option>50</option><option>100</option></select></div>
<div class="spacer"></div>
<button class="btn secondary" id="btnSearchTrans"><svg viewBox="0 0 24 24" fill="none"><path d="M10.5 17a6.5 6.5 0 1 1 4.596-11.104A6.5 6.5 0 0 1 10.5 17Zm0 0L19 21" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>Buscar</button>
<button class="btn ghost" id="btnResetTrans"><svg viewBox="0 0 24 24" fill="none"><path d="M3 12a9 9 0 1 0 9-9M3 4v8h8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>Limpar</button>
</div>
<div class="tablewrap">
<table aria-label="Tabela de transações">
<thead><tr><th>Data</th><th>Usuário</th><th>Plano</th><th>Valor</th><th>Hash</th><th>Status</th><th>Ativado</th><th>Ações</th></tr></thead>
<tbody id="tblTrans"></tbody>
</table>
</div>
<div class="pagination">
<button class="iconbtn" id="prevTrans" aria-label="Página anterior"><svg viewBox="0 0 24 24" fill="none"><path d="M15 6 9 12l6 6" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg></button>
<div class="small" id="pgInfoTrans">—</div>
<button class="iconbtn" id="nextTrans" aria-label="Próxima página"><svg viewBox="0 0 24 24" fill="none"><path d="M9 6l6 6-6 6" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg></button>
</div>
</div>
</div>
</section>

<section id="tab-users" class="hidden" role="tabpanel" aria-labelledby="nav-users">
<div class="section">
<div class="card">
<div class="toolbar">
<div class="field" style="min-width:220px"><label>Busca</label><input id="uQ" type="search" class="input" placeholder="usuário ou e-mail"></div>
<div class="field"><label>Admin</label><select id="uAdmin"><option value="">Todos</option><option value="yes">Sim</option><option value="no">Não</option></select></div>
<div class="field"><label>Ativo</label><select id="uDisabled"><option value="">Todos</option><option value="false">Ativo</option><option value="true">Desativado</option></select></div>
<div class="field"><label>Tamanho</label><select id="uPageSize"><option>20</option><option>50</option><option>100</option></select></div>
<div class="spacer"></div>
<button class="btn secondary" id="btnSearchUsers"><svg viewBox="0 0 24 24" fill="none"><path d="M10.5 17a6.5 6.5 0 1 1 4.596-11.104A6.5 6.5 0 0 1 10.5 17Zm0 0L19 21" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>Buscar</button>
<button class="btn ghost" id="btnResetUsers"><svg viewBox="0 0 24 24" fill="none"><path d="M3 12a9 9 0 1 0 9-9M3 4v8h8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>Limpar</button>
</div>
<div class="tablewrap">
<table aria-label="Tabela de usuários">
<thead><tr><th>Criado</th><th>Usuário</th><th>E-mail</th><th>Plano</th><th>Expira</th><th>Admin</th><th>Status</th><th>Último login</th><th>Ações</th></tr></thead>
<tbody id="tblUsers"></tbody>
</table>
</div>
<div class="pagination">
<button class="iconbtn" id="prevUsers" aria-label="Página anterior"><svg viewBox="0 0 24 24" fill="none"><path d="M15 6 9 12l6 6" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg></button>
<div class="small" id="pgInfoUsers">—</div>
<button class="iconbtn" id="nextUsers" aria-label="Próxima página"><svg viewBox="0 0 24 24" fill="none"><path d="M9 6l6 6-6 6" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg></button>
</div>
</div>
</div>
</section>

<section id="tab-plans" class="hidden" role="tabpanel" aria-labelledby="nav-plans">
<div class="section">
<div class="card">
<div class="grid cols-2" id="plansGrid"></div>
<hr>
<div style="display:flex;gap:8px;justify-content:flex-end">
<button class="btn ghost" id="btnReloadPlans"><svg viewBox="0 0 24 24" fill="none"><path d="M21 12a9 9 0 1 1-2.64-6.36M21 4v6h-6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>Recarregar</button>
<button class="btn" id="btnSavePlans"><svg viewBox="0 0 24 24" fill="none"><path d="M5 12l4 4L19 6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>Salvar alterações</button>
</div>
</div>
</div>
</section>
</main>
</div>

<div class="modal" id="confirmModal" aria-hidden="true" aria-modal="true" role="dialog">
<div class="overlay" id="confirmOverlay"></div>
<div class="dialog">
<div class="head"><div id="confirmTitle">Confirmar</div><button class="iconbtn" id="confirmClose" aria-label="Fechar"><svg viewBox="0 0 24 24" fill="none"><path d="M6 6l12 12M18 6 6 18" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg></button></div>
<div id="confirmBody" class="small">Tem certeza?</div>
<hr>
<div style="display:flex;gap:8px;justify-content:flex-end">
<button class="btn ghost" id="btnCancelConfirm">Cancelar</button>
<button class="btn" id="btnOkConfirm">Confirmar</button>
</div>
</div>
</div>

<div class="modal" id="receiptModal" aria-hidden="true" aria-modal="true" role="dialog">
<div class="overlay" id="receiptOverlay"></div>
<div class="dialog">
<div class="head"><div id="receiptTitle">Comprovante de Pagamento</div><button class="iconbtn" id="receiptClose" aria-label="Fechar"><svg viewBox="0 0 24 24" fill="none"><path d="M6 6l12 12M18 6 6 18" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg></button></div>
<div id="receiptBody"></div>
<hr>
<div style="display:flex;gap:8px;justify-content:flex-end">
<button class="btn ghost" id="btnCopyReceipt"><svg viewBox="0 0 24 24" fill="none"><path d="M8 8h8v12H8zM12 4h6v4" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/></svg>Copiar JSON</button>
<button class="btn ghost" id="btnDownloadReceipt"><svg viewBox="0 0 24 24" fill="none"><path d="M12 3v12m0 0 4-4m-4 4-4-4M5 21h14" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>Baixar JSON</button>
<button class="btn" id="btnPrintReceipt"><svg viewBox="0 0 24 24" fill="none"><path d="M6 9V4h12v5M6 13H4v7h16v-7h-2M8 17h8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>Imprimir</button>
</div>
</div>
</div>

<div class="toast" aria-live="polite" aria-atomic="true" id="toast"></div>

<script>
const $=s=>document.querySelector(s),$$=s=>Array.from(document.querySelectorAll(s))
const fmtBRL=new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'})
const fmtDate=v=>v?new Date(v).toLocaleString('pt-BR'):'—'
const text=(el,v)=>{if(!el)return;el.textContent=v??'—'}
const toast=(msg,dur=2600)=>{const t=document.createElement('div');t.className='msg';t.textContent=msg;$('#toast').appendChild(t);setTimeout(()=>t.remove(),dur)}
const setBadge=status=>{const s=(status||'').toLowerCase();const span=document.createElement('span');span.className='badge '+(s.includes('paid')||s.includes('approved')||s.includes('completed')||s.includes('confirmed')||s.includes('accredited')||s.includes('credited')?'paid':(s.includes('fail')||s.includes('cancel')||s.includes('chargeback')||s.includes('reverse')||s.includes('void')||s.includes('denied')||s.includes('expired')?'failed':'pending'));span.textContent=status||'pendente';return span}
let autoTimer=null
const startAuto=()=>{stopAuto();autoTimer=setInterval(()=>refreshActiveTab(),10000)}
const stopAuto=()=>{if(autoTimer){clearInterval(autoTimer);autoTimer=null}}
const closeSidebar=()=>$('#sidebar').classList.remove('open')
const state={trans:{page:1,size:20,filters:{}},users:{page:1,size:20,filters:{}},plans:{data:{},dirty:{}},receipt:{data:null,raw:''}}
const api={get:async(u)=>{const r=await fetch(u,{headers:{Accept:'application/json'}});let d=null;try{d=await r.json()}catch(e){}if(!r.ok)throw new Error((d&&d.error)||('Erro '+r.status));return d},post:async(u,b)=>{const r=await fetch(u,{method:'POST',headers:{'Content-Type':'application/json',Accept:'application/json'},body:JSON.stringify(b||{})});let d=null;try{d=await r.json()}catch(e){}if(!r.ok)throw new Error((d&&d.error)||('Erro '+r.status));return d},patch:async(u,b)=>{const r=await fetch(u,{method:'PATCH',headers:{'Content-Type':'application/json',Accept:'application/json'},body:JSON.stringify(b||{})});let d=null;try{d=await r.json()}catch(e){}if(!r.ok)throw new Error((d&&d.error)||('Erro '+r.status));return d},del:async(u)=>{const r=await fetch(u,{method:'DELETE',headers:{Accept:'application/json'}});let d=null;try{d=await r.json()}catch(e){}if(!r.ok)throw new Error((d&&d.error)||('Erro '+r.status));return d}}
const nav={show:(id)=>{$$('#nav-dashboard,#nav-trans,#nav-users,#nav-plans').forEach(b=>b.removeAttribute('aria-current'));$('#nav-'+id).setAttribute('aria-current','page');$$('[role="tabpanel"]').forEach(s=>s.classList.add('hidden'));$('#tab-'+id).classList.remove('hidden');closeSidebar();refreshActiveTab()}}
const syncTime=()=>{const now=new Date();text($('#lastSync'),'Sincronizado às '+now.toLocaleTimeString('pt-BR'))}
const loadMetrics=async()=>{try{text($('#kpiToday'),'—');text($('#kpi7d'),'—');text($('#kpi30d'),'—');const j=await api.get('/admin/api/metrics');text($('#kpiToday'),fmtBRL.format((j.revenue_today_cents||0)/100));text($('#kpi7d'),fmtBRL.format((j.revenue_7d_cents||0)/100));text($('#kpi30d'),fmtBRL.format((j.revenue_30d_cents||0)/100));text($('#kpiTodayCount'),(j.count_today||0)+' ativações hoje');text($('#kpi7dCount'),(j.count_7d||0)+' ativações/7d');text($('#kpi30dCount'),(j.count_30d||0)+' ativações/30d');text($('#kpiTx'),'Pagas: '+(j.tx_counts?.paid||0));text($('#kpiSplit'),'Pendentes: '+(j.tx_counts?.pending||0)+' · Falhas: '+(j.tx_counts?.failed||0));const pills=$('#aggPills');pills.innerHTML='';['pending','paid','failed'].forEach(k=>{const v=j.tx_counts?.[k]||0;const p=document.createElement('span');p.className='pill';p.textContent=(k==='pending'?'Pendentes':k==='paid'?'Pagas':'Falhas')+': '+v;pills.appendChild(p)});syncTime()}catch(e){toast(String(e.message||e))}}
const readTransFilters=()=>{const f={};const s=$('#fStatus').value.trim();if(s){if(s==='pending')f.status='';else f.status=s}const p=$('#fPlan').value.trim();if(p)f.plan=p;const d1=$('#fFrom').value;if(d1)f.from=new Date(d1).toISOString();const d2=$('#fTo').value;if(d2)f.to=new Date(d2).toISOString();const q=$('#fQ').value.trim();if(q)f.q=q;state.trans.size=parseInt($('#fPageSize').value,10)||20;state.trans.filters=f}
const loadTrans=async()=>{try{readTransFilters();const page=state.trans.page;const size=state.trans.size;const f=state.trans.filters;const params=new URLSearchParams();if(f.status!==undefined){if(f.status)params.set('status',f.status)}if(f.plan)params.set('plan',f.plan);if(f.from)params.set('from',f.from);if(f.to)params.set('to',f.to);if(f.q)params.set('q',f.q);params.set('page',String(page));params.set('page_size',String(size));const j=await api.get('/admin/api/transactions?'+params.toString());const tbody=$('#tblTrans');tbody.innerHTML='';if((j.items||[]).length===0){const tr=document.createElement('tr');const td=document.createElement('td');td.colSpan=8;td.className='small';td.textContent='Nenhum resultado';tr.appendChild(td);tbody.appendChild(tr)}(j.items||[]).forEach(it=>{const tr=document.createElement('tr');const td1=document.createElement('td');td1.textContent=fmtDate(it.created_at);const td2=document.createElement('td');td2.textContent=it.username||'—';const td3=document.createElement('td');td3.textContent=it.plan||'—';const td4=document.createElement('td');td4.textContent=fmtBRL.format((it.amount_cents||0)/100);const td5=document.createElement('td');const hspan=document.createElement('span');hspan.textContent=(it.hash||'').slice(0,10)+'…';const copyBtn=document.createElement('button');copyBtn.className='btn ghost small';copyBtn.setAttribute('aria-label','Copiar hash');copyBtn.innerHTML='<svg viewBox="0 0 24 24" fill="none"><path d="M8 8h8v12H8zM12 4h6v4" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/></svg><span>Copiar</span>';copyBtn.onclick=()=>{navigator.clipboard.writeText(it.hash||'');toast('Hash copiado')};const hv=document.createElement('div');hv.style.display='flex';hv.style.alignItems='center';hv.style.gap='6px';hv.append(hspan,copyBtn);td5.appendChild(hv);const td6=document.createElement('td');td6.appendChild(setBadge(it.payment_status||'pendente'));const td7=document.createElement('td');td7.textContent=it.activated_at?fmtDate(it.activated_at):'—';const td8=document.createElement('td');const bPay=document.createElement('button');bPay.className='btn success small';bPay.innerHTML='<svg viewBox="0 0 24 24" fill="none"><path d="M5 12l4 4L19 6" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg><span>Marcar como pago</span>';bPay.onclick=async()=>{try{await api.patch('/admin/api/transactions/'+it.id,{payment_status:'paid'});toast('Status atualizado');loadTrans();loadMetrics()}catch(e){toast(String(e.message||e))}};const bFail=document.createElement('button');bFail.className='btn warn small';bFail.innerHTML='<svg viewBox="0 0 24 24" fill="none"><path d="M12 9v4m0 4h.01M10.3 4.7 3.7 17.3A2 2 0 0 0 5.5 20h13a2 2 0 0 0 1.8-2.7L13.7 4.7a2 2 0 0 0-3.4 0Z" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg><span>Marcar como falhou</span>';bFail.onclick=async()=>{try{await api.patch('/admin/api/transactions/'+it.id,{payment_status:'failed'});toast('Status atualizado');loadTrans();loadMetrics()}catch(e){toast(String(e.message||e))}};const bSet=document.createElement('button');bSet.className='btn ghost small';bSet.innerHTML='<svg viewBox="0 0 24 24" fill="none"><path d="M4 7h10m-4 5h8m-6 5h6" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"/></svg><span>Definir status</span>';bSet.onclick=()=>openConfirm('Definir status','Informe o novo status para a transação '+(it.hash||''),async(val)=>{if(!val)return;try{await api.patch('/admin/api/transactions/'+it.id,{payment_status:String(val).toLowerCase()});toast('Status atualizado');loadTrans();loadMetrics()}catch(e){toast(String(e.message||e))}},true);const bDel=document.createElement('button');bDel.className='btn danger small';bDel.innerHTML='<svg viewBox="0 0 24 24" fill="none"><path d="M6 7h12M9 7V5a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2M9 11v6M15 11v6M6 7l1 14a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2l1-14" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"/></svg><span>Excluir</span>';bDel.onclick=()=>openConfirm('Excluir transação','Esta ação não pode ser desfeita. Deseja excluir?',async()=>{try{await api.del('/admin/api/transactions/'+it.id);toast('Transação excluída');loadTrans();loadMetrics()}catch(e){toast(String(e.message||e))}});const bRc=document.createElement('button');bRc.className='btn ghost small';bRc.innerHTML='<svg viewBox="0 0 24 24" fill="none"><path d="M7 7h10v10H7zM9 3h6v4" stroke="currentColor" stroke-width="1.4" stroke-linejoin="round"/></svg><span>Comprovante</span>';bRc.onclick=async()=>{await openReceipt(it.id,it.receipt_id)};const ra=document.createElement('div');ra.className='rowactions';ra.append(bRc,bPay,bFail,bSet,bDel);td8.appendChild(ra);tr.append(td1,td2,td3,td4,td5,td6,td7,td8);tbody.appendChild(tr)});text($('#pgInfoTrans'),'Página '+j.page+' de '+Math.max(1,Math.ceil((j.total||0)/j.page_size)));$('#prevTrans').disabled=j.page<=1;$('#nextTrans').disabled=(j.page||1)>=Math.ceil((j.total||0)/j.page_size)}catch(e){toast(String(e.message||e))}}
const resetTrans=()=>{$('#fStatus').value='';$('#fPlan').value='';$('#fFrom').value='';$('#fTo').value='';$('#fQ').value='';$('#fPageSize').value='20';state.trans.page=1;loadTrans()}
$('#btnSearchTrans').onclick=()=>{state.trans.page=1;loadTrans()}
$('#btnResetTrans').onclick=resetTrans
$('#prevTrans').onclick=()=>{if(state.trans.page>1){state.trans.page--;loadTrans()}}
$('#nextTrans').onclick=()=>{state.trans.page++;loadTrans()}
const readUserFilters=()=>{const f={};const q=$('#uQ').value.trim();if(q)f.q=q;const a=$('#uAdmin').value;if(a)f.admin=a;const d=$('#uDisabled').value;if(d)f.disabled=d;state.users.size=parseInt($('#uPageSize').value,10)||20;state.users.filters=f}
const loadUsers=async()=>{try{readUserFilters();const page=state.users.page;const size=state.users.size;const f=state.users.filters;const params=new URLSearchParams();if(f.q)params.set('q',f.q);if(f.admin)params.set('admin',f.admin);if(f.disabled)params.set('disabled',f.disabled);params.set('page',String(page));params.set('page_size',String(size));const j=await api.get('/admin/api/users?'+params.toString());const tbody=$('#tblUsers');tbody.innerHTML='';if((j.items||[]).length===0){const tr=document.createElement('tr');const td=document.createElement('td');td.colSpan=9;td.className='small';td.textContent='Nenhum resultado';tr.appendChild(td);tbody.appendChild(tr)}(j.items||[]).forEach(u=>{const tr=document.createElement('tr');const td1=document.createElement('td');td1.textContent=fmtDate(u.created_at);const td2=document.createElement('td');td2.textContent=u.username||'—';const td3=document.createElement('td');td3.textContent=u.email||'—';const td4=document.createElement('td');td4.textContent=(u.plans||'padrao');const td5=document.createElement('td');td5.textContent=u.plan_expires_at?fmtDate(u.plan_expires_at):'—';const td6=document.createElement('td');const bA=document.createElement('span');bA.className='badge '+(u.admin_permission==='yes'?'paid':'pending');bA.textContent=u.admin_permission==='yes'?'admin':'não';td6.appendChild(bA);const td7=document.createElement('td');const bS=document.createElement('span');bS.className='badge '+(u.disabled?'failed':'paid');bS.textContent=u.disabled?'desativado':'ativo';td7.appendChild(bS);const td8=document.createElement('td');td8.textContent=u.last_login_at?fmtDate(u.last_login_at):'—';const td9=document.createElement('td');const mkAdmin=document.createElement('button');mkAdmin.className='btn ghost small';mkAdmin.innerHTML='<svg viewBox="0 0 24 24" fill="none"><path d="M12 3l3 7h7l-5.5 4.2L18 21l-6-4-6 4 1.5-6.8L2 10h7l3-7z" stroke="currentColor" stroke-width="1.2" stroke-linejoin="round"/></svg><span>'+(u.admin_permission==='yes'?'Remover admin':'Tornar admin')+'</span>';mkAdmin.onclick=async()=>{try{await api.post('/admin/api/users/'+u.id+'/set_admin',{admin_permission:u.admin_permission==='yes'?'no':'yes'});toast('Permissão atualizada');loadUsers()}catch(e){toast(String(e.message||e))}};const toggleDis=document.createElement('button');toggleDis.className='btn warn small';toggleDis.innerHTML='<svg viewBox="0 0 24 24" fill="none"><path d="M12 9v4m0 4h.01M10.3 4.7 3.7 17.3A2 2 0 0 0 5.5 20h13a2 2 0 0 0 1.8-2.7L13.7 4.7a2 2 0 0 0-3.4 0Z" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg><span>'+(u.disabled?'Habilitar usuário':'Desabilitar usuário')+'</span>';toggleDis.onclick=async()=>{try{await api.post('/admin/api/users/'+u.id+'/disable',{disabled:!u.disabled});toast('Status do usuário atualizado');loadUsers()}catch(e){toast(String(e.message||e))}};const forceOut=document.createElement('button');forceOut.className='btn danger small';forceOut.innerHTML='<svg viewBox="0 0 24 24" fill="none"><path d="M8 12h8M12 16l4-4-4-4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg><span>Forçar logout</span>';forceOut.onclick=async()=>{try{await api.post('/admin/api/users/'+u.id+'/force_logout',{});toast('Logout forçado')}catch(e){toast(String(e.message||e))}};const ra=document.createElement('div');ra.className='rowactions';ra.append(mkAdmin,toggleDis,forceOut);td9.appendChild(ra);tr.append(td1,td2,td3,td4,td5,td6,td7,td8,td9);tbody.appendChild(tr)});text($('#pgInfoUsers'),'Página '+j.page+' de '+Math.max(1,Math.ceil((j.total||0)/j.page_size)));$('#prevUsers').disabled=j.page<=1;$('#nextUsers').disabled=(j.page||1)>=Math.ceil((j.total||0)/j.page_size)}catch(e){toast(String(e.message||e))}}
$('#btnSearchUsers').onclick=()=>{state.users.page=1;loadUsers()}
$('#btnResetUsers').onclick=()=>{$('#uQ').value='';$('#uAdmin').value='';$('#uDisabled').value='';$('#uPageSize').value='20';state.users.page=1;loadUsers()}
$('#prevUsers').onclick=()=>{if(state.users.page>1){state.users.page--;loadUsers()}}
$('#nextUsers').onclick=()=>{state.users.page++;loadUsers()}
const renderPlans=async()=>{try{const j=await api.get('/admin/api/plans');state.plans.data=j.plans||{};const grid=$('#plansGrid');grid.innerHTML='';Object.entries(state.plans.data).forEach(([name,p])=>{const card=document.createElement('div');card.className='card';const title=document.createElement('div');title.style.display='flex';title.style.justifyContent='space-between';title.style.alignItems='center';const h=document.createElement('h3');h.style.margin='0';h.textContent=name;const togg=document.createElement('label');togg.className='switch';const inp=document.createElement('input');inp.type='checkbox';inp.checked=!!p.active;const slider=document.createElement('span');slider.className='slider';togg.append(inp,slider);title.append(h,togg);const fwrap=document.createElement('div');fwrap.className='grid cols-2';const f1=document.createElement('div');f1.className='field';const l1=document.createElement('label');l1.textContent='Preço (R$)';const i1=document.createElement('input');i1.type='text';i1.inputMode='decimal';i1.className='input';i1.value=((p.amount_cents||0)/100).toFixed(2).replace('.',',');f1.append(l1,i1);const f2=document.createElement('div');f2.className='field';const l2=document.createElement('label');l2.textContent='Título';const i2=document.createElement('input');i2.type='text';i2.className='input';i2.value=p.title||'';i2.disabled=true;f2.append(l2,i2);const f3=document.createElement('div');f3.className='field';const l3=document.createElement('label');l3.textContent='Product Hash';const i3=document.createElement('input');i3.type='text';i3.className='input';i3.value=p.product_hash||'';i3.disabled=true;f3.append(l3,i3);const f4=document.createElement('div');f4.className='field';const l4=document.createElement('label');l4.textContent='Offer Hash';const i4=document.createElement('input');i4.type='text';i4.className='input';i4.value=p.offer_hash||'';i4.disabled=true;f4.append(l4,i4);fwrap.append(f1,f2,f3,f4);card.append(title,document.createElement('hr'),fwrap);grid.appendChild(card);const setDirty=()=>{state.plans.dirty[name]={amount_cents:toCents(i1.value),active:inp.checked}};inp.onchange=setDirty;i1.oninput=setDirty})}catch(e){toast(String(e.message||e))}}
const toCents=v=>{const s=String(v||'').trim().replace(/\./g,'').replace(',','.');const n=Number(s);if(!isFinite(n))return 0;return Math.round(n*100)}
$('#btnSavePlans').onclick=async()=>{try{if(!Object.keys(state.plans.dirty).length){toast('Nada para salvar');return}const put=await fetch('/admin/api/plans',{method:'PUT',headers:{'Content-Type':'application/json',Accept:'application/json'},body:JSON.stringify(state.plans.dirty)});if(!put.ok){toast('Falha ao salvar');return}await put.json();state.plans.dirty={};toast('Planos atualizados');renderPlans();loadMetrics()}catch(e){toast(String(e.message||e))}}
$('#btnReloadPlans').onclick=()=>renderPlans()
const openConfirm=(title,body,ok,needInput)=>{const m=$('#confirmModal');text($('#confirmTitle'),title||'Confirmar');const bodyEl=$('#confirmBody');bodyEl.innerHTML='';if(needInput){const w=document.createElement('div');w.style.display='grid';w.style.gap='8px';const p=document.createElement('div');p.className='small';p.textContent=body||'';const inp=document.createElement('input');inp.type='text';inp.className='input';inp.placeholder='Novo valor';w.append(p,inp);bodyEl.append(w);m.dataset.valueTarget='1';m.dataset.inputId='confirmInput';inp.id='confirmInput';setTimeout(()=>inp.focus(),30)}else{bodyEl.textContent=body||'Tem certeza?';delete m.dataset.valueTarget}m.classList.add('open');m.setAttribute('aria-hidden','false');const cleanup=()=>{m.classList.remove('open');m.setAttribute('aria-hidden','true')};$('#btnCancelConfirm').onclick=cleanup;$('#confirmClose').onclick=cleanup;$('#confirmOverlay').onclick=cleanup;$('#btnOkConfirm').onclick=async()=>{const value=m.dataset.valueTarget?$('#confirmInput').value:null;cleanup();if(typeof ok==='function')await ok(value)}}
const buildKV=(k,v)=>{const r=document.createElement('div');r.className='kv';const a=document.createElement('div');a.textContent=k;const b=document.createElement('div');b.textContent=v==null?'—':String(v);r.append(a,b);return r}
const renderReceiptView=rec=>{const el=$('#receiptBody');el.innerHTML='';const wrap=document.createElement('div');const h1=document.createElement('div');h1.className='sectiontitle';h1.textContent='Cabeçalho';wrap.append(h1,buildKV('ID do Comprovante',rec.receipt_id||'—'),buildKV('Emitido em',fmtDate(rec.issued_at)),buildKV('Moeda',rec.currency||'—'));const h2=document.createElement('div');h2.className='sectiontitle';h2.textContent='Dados do Usuário';wrap.append(h2,buildKV('Usuário ID',rec.user?.id||'—'),buildKV('Usuário',rec.user?.username||'—'),buildKV('E-mail',rec.user?.email||'—'),buildKV('Criado em',fmtDate(rec.user?.created_at)),buildKV('Último login',fmtDate(rec.user?.last_login_at)),buildKV('Admin',rec.user?.admin_permission||'—'),buildKV('Desativado',String(rec.user?.disabled)));const h3=document.createElement('div');h3.className='sectiontitle';h3.textContent='Transação';wrap.append(h3,buildKV('Transação ID',rec.transaction?.id||'—'),buildKV('Hash',rec.transaction?.hash||'—'),buildKV('Status',rec.transaction?.payment_status||'—'),buildKV('Plano (nome)',rec.transaction?.plan_name||'—'),buildKV('Valor',fmtBRL.format((rec.transaction?.amount_cents||0)/100)),buildKV('Criada em',fmtDate(rec.transaction?.created_at)),buildKV('Atualizada em',fmtDate(rec.transaction?.updated_at)),buildKV('Ativada em',fmtDate(rec.transaction?.activated_at)),buildKV('Falhou em',fmtDate(rec.transaction?.failed_at)));const h4=document.createElement('div');h4.className='sectiontitle';h4.textContent='Plano';wrap.append(h4,buildKV('Código',rec.plan?.code||'—'),buildKV('Título',rec.plan?.title||'—'),buildKV('Product Hash',rec.plan?.product_hash||'—'),buildKV('Offer Hash',rec.plan?.offer_hash||'—'),buildKV('Período (dias)',rec.plan?.period_days==null?'—':String(rec.plan?.period_days)));const h5=document.createElement('div');h5.className='sectiontitle';h5.textContent='Entrega do Serviço';wrap.append(h5,buildKV('Entregue',String(!!rec.service_delivery?.granted)),buildKV('Entregue em',fmtDate(rec.service_delivery?.granted_at)),buildKV('Expira em',fmtDate(rec.service_delivery?.expires_at)),buildKV('Nível de acesso',rec.service_delivery?.access_level||'—'));const h6=document.createElement('div');h6.className='sectiontitle';h6.textContent='Assinatura';wrap.append(h6,buildKV('Assinatura',rec.signature||'—'));const h7=document.createElement('div');h7.className='sectiontitle';h7.textContent='JSON completo';const pre=document.createElement('pre');pre.id='receiptJson';pre.textContent=JSON.stringify(rec,null,2);wrap.append(h7,pre);el.appendChild(wrap)}
const openReceipt=async(id)=>{try{const j=await api.get('/admin/api/transactions/'+id+'/receipt');state.receipt.data=j.receipt;state.receipt.raw=JSON.stringify(j.receipt,null,2);renderReceiptView(j.receipt);const m=$('#receiptModal');m.classList.add('open');m.setAttribute('aria-hidden','false')}catch(e){toast(String(e.message||e))}}
const closeReceipt=()=>{const m=$('#receiptModal');m.classList.remove('open');m.setAttribute('aria-hidden','true')}
$('#btnCopyReceipt').onclick=()=>{if(!state.receipt.raw)return;navigator.clipboard.writeText(state.receipt.raw).then(()=>toast('Comprovante copiado'))}
$('#btnDownloadReceipt').onclick=()=>{if(!state.receipt.data)return;const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([state.receipt.raw],{type:'application/json'}));a.download=(state.receipt.data.receipt_id||'comprovante')+'.json';document.body.appendChild(a);a.click();URL.revokeObjectURL(a.href);a.remove()}
$('#btnPrintReceipt').onclick=()=>{window.print()}
$('#receiptClose').onclick=closeReceipt
$('#receiptOverlay').onclick=closeReceipt
const refreshActiveTab=()=>{const active=$$('.nav button[aria-current="page"]')[0]?.id||'';if(active==='nav-dashboard'){loadMetrics()}else if(active==='nav-trans'){loadTrans()}else if(active==='nav-users'){loadUsers()}else if(active==='nav-plans'){renderPlans()}}
$('#nav-dashboard').onclick=()=>{nav.show('dashboard')}
$('#nav-trans').onclick=()=>{nav.show('trans')}
$('#nav-users').onclick=()=>{nav.show('users')}
$('#nav-plans').onclick=()=>{nav.show('plans')}
$('#btnRefresh').onclick=()=>refreshActiveTab()
$('#goTrans').onclick=()=>{$('#nav-trans').click()}
$('#goUsers').onclick=()=>{$('#nav-users').click()}
$('#goPlans').onclick=()=>{$('#nav-plans').click()}
$('#btnMenu').onclick=()=>$('#sidebar').classList.toggle('open')
$('#autoTick').onchange=e=>{if(e.target.checked)startAuto();else stopAuto()}
document.addEventListener('visibilitychange',()=>{if(document.hidden)stopAuto();else if($('#autoTick').checked)startAuto()})
window.addEventListener('keydown',e=>{if(e.key==='Escape')$('#sidebar').classList.remove('open')})
loadMetrics().then(()=>syncTime())
renderPlans()
loadTrans()
loadUsers()
startAuto()
</script>
</body>
</html>